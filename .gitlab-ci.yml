variables:
  DEPLOYMENT_BUCKET_NAME: aws-hcls-ml
  DEV_BUCKET_PREFIX: blog_post_support_materials/aws-alphafold/dev
  PROD_BUCKET_PREFIX: blog_post_support_materials/aws-alphafold/prod

default:
  image: public.ecr.aws/amazonlinux/amazonlinux:latest

include:
  - template: Security/Secret-Detection.gitlab-ci.yml

cfn-lint:
  image: python:latest
  stage: test
  before_script:
    - python --version  # For debugging
    - pip install virtualenv
    - virtualenv venv
    - source venv/bin/activate
    - pip install cfn-lint
    - pip freeze    
  script:
    - cfn-lint -I infrastructure/*.yaml

cfn-nag:
  image: stelligent/cfn_nag
  stage: test
  script:
    - cfn_nag_scan --input-path infrastructure/*.yaml

secret_detection:
  stage: test
  variables:
    CI_DEBUG_TRACE: "true"

push-to-s3-dev:
  stage: deploy
  variables:
    AWS_CREDS_TARGET_ROLE: arn:aws:iam::111918798052:role/AWS-Alphafold-GitLab-CI-Role
    AWS_DEFAULT_REGION: us-east-1
  before_script:
    - yum update -y && yum install -y awscli zip
  script:
    - zip -r aws-alphafold.zip . -x .\*/\* -x .gitlab-ci.yml
    - aws s3 cp aws-alphafold.zip s3://$(DEPLOYMENT_BUCKET_NAME)/$(DEV_BUCKET_PREFIX)/aws-alphafold.zip
    - aws cloudformation package --template-file infrastructure/alphafold-cfn-root.yaml --output-template alphafold-cfn-packaged.yaml --s3-bucket $(DEPLOYMENT_BUCKET_NAME) --s3_prefix $(DEV_BUCKET_PREFIX)
    - aws s3 cp infrastructure/alphafold-cfn-root.yaml s3://$(DEPLOYMENT_BUCKET_NAME)/$(DEV_BUCKET_PREFIX)/alphafold-cfn-root.yaml
  only:
    - dev

push-to-s3-main:
  stage: deploy
  variables:
    AWS_CREDS_TARGET_ROLE: arn:aws:iam::111918798052:role/AWS-Alphafold-GitLab-CI-Role
    AWS_DEFAULT_REGION: us-east-1
  before_script:
    - yum update -y && yum install -y awscli zip
  script:
    - zip -r aws-alphafold.zip . -x .\*/\* -x .gitlab-ci.yml
    - aws s3 cp aws-alphafold.zip s3://aws-hcls-ml/blog_post_support_materials/aws-alphafold/main/aws-alphafold.zip
    - aws s3 cp infrastructure/*.yaml s3://aws-hcls-ml/blog_post_support_materials/aws-alphafold/main/cfn.yaml    
  only:
    - main