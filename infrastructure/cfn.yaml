# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0

AWSTemplateFormatVersion: 2010-09-09
Description: >-
  Creates a stack for running Alphafold on AWS Batch.
Parameters:
  StackAvailabilityZone:
    Description: Availability zone to deploy stack resources
    Type: "AWS::EC2::AvailabilityZone::Name"
  LaunchSageMakerNotebook:
    Type: String 
    Default: Y
    Description: Create a SageMaker Notebook Instance.
    AllowedValues: [Y, N]
  FSXForLustreStorageCapacity:
    Description: Storage capacity in GB, 1200 or increments of 2400.
    Type: String
    AllowedValues:
      - 1200
      - 2400
      - 4800
      - 7200
    Default: 1200
  FSxForLustreThroughput:
    Description: Throughput for unit storage (MB/s/TB) to provision for FSx for Lustre file system.
    Type: Number
    AllowedValues:
      - 125
      - 250
      - 500
      - 1000
    Default: 500    
  AlphaFoldVersion:
    Description: AlphaFold release to include as part of the job container
    Type: String
    Default: v2.1.2
    AllowedValues:
      - v2.1.2  
Conditions:
  createSageMakerNotebook: !Equals [ !Ref 'LaunchSageMakerNotebook', 'Y' ]
Resources:
  ##################################################
  # Network Configuration
  ##################################################
  VPC:
    Type: "AWS::EC2::VPC"
    Properties:
      EnableDnsSupport: "true"
      EnableDnsHostnames: "true"
      CidrBlock: "10.0.0.0/16"
      Tags:
        - Key: Application
          Value: AWS-Alphafold
        - Key: Network
          Value: Public
        - Key: Name
          Value:
            !Join [
              "-",
              [
                "AWS-Alphafold",
                "VPC",
                !Select [
                  4,
                  !Split ["-", !Select [2, !Split ["/", !Ref AWS::StackId]]],
                ],
              ],
            ]
        - Key: StackId
          Value: !Ref AWS::StackId

  VPCFlowLogRole:
    Type: "AWS::IAM::Role"
    Properties:
      Description: "Required service policies to support running Alphafold on AWS Batch"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - vpc-flow-logs.amazonaws.com
            Action:
              - "sts:AssumeRole"
      Policies:
        - PolicyName: VPCFlowLogPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - logs:DescribeLogGroups
                  - logs:DescribeLogStreams
                Resource: !Sub arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:vpc-flow-log/*
      Tags:
        - Key: Application
          Value: AWS-Alphafold
        - Key: Name
          Value:
            !Join [
              "-",
              [
                "AWS-Alphafold",
                "flow-log-role",
                !Select [
                  4,
                  !Split ["-", !Select [2, !Split ["/", !Ref AWS::StackId]]],
                ],
              ],
            ]
        - Key: StackId
          Value: !Ref AWS::StackId

  VPCFlowLogsGroup:
    Type: AWS::Logs::LogGroup
    Properties: 
      KmsKeyId: !GetAtt EncryptionKey.Arn
      RetentionInDays: 120
      Tags: 
        - Key: Name
          Value:
            !Join [
              "-",
              [
                "AWS-Alphafold",
                "flow-log-group",
                !Select [
                  4,
                  !Split ["-", !Select [2, !Split ["/", !Ref AWS::StackId]]],
                ],
              ],
            ]
        - Key: StackId
          Value: !Ref AWS::StackId

  VPCFlowLog:
    Type: "AWS::EC2::FlowLog"
    Properties: 
      DeliverLogsPermissionArn: !GetAtt VPCFlowLogRole.Arn
      LogGroupName: !Ref VPCFlowLogsGroup    
      ResourceId: !Ref VPC
      ResourceType: VPC
      Tags: 
        - Key: Name
          Value:
            !Join [
              "-",
              [
                "AWS-Alphafold",
                "VPCFlowLog",
                !Select [
                  4,
                  !Split ["-", !Select [2, !Split ["/", !Ref AWS::StackId]]],
                ],
              ],
            ]
        - Key: StackId
          Value: !Ref AWS::StackId
      TrafficType: ALL

  PublicSubnet0:
    Type: "AWS::EC2::Subnet"
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Ref StackAvailabilityZone
      CidrBlock:
        Fn::Select:
          - 0
          - Fn::Cidr: [!GetAtt VPC.CidrBlock, 6, 8]
      Tags:
        - Key: Application
          Value: AWS-Alphafold
        - Key: Network
          Value: Public
        - Key: Name
          Value:
            !Join [
              "-",
              [
                "AWS-Alphafold",
                "public-subnet",
                !Select [
                  4,
                  !Split ["-", !Select [2, !Split ["/", !Ref AWS::StackId]]],
                ],
              ],
            ]
        - Key: StackId
          Value: !Ref AWS::StackId

  PrivateSubnet0:
    Type: "AWS::EC2::Subnet"
    Properties:
      VpcId:
        Ref: VPC
      AvailabilityZone: !Ref StackAvailabilityZone
      MapPublicIpOnLaunch: false
      CidrBlock:
        Fn::Select:
          - 3
          - Fn::Cidr: [!GetAtt VPC.CidrBlock, 6, 8]
      Tags:
        - Key: Application
          Value: AWS-Alphafold
        - Key: Network
          Value: Private
        - Key: Name
          Value:
            !Join [
              "-",
              [
                "AWS-Alphafold",
                "private-subnet",
                !Select [
                  4,
                  !Split ["-", !Select [2, !Split ["/", !Ref AWS::StackId]]],
                ],
              ],
            ]
        - Key: StackId
          Value: !Ref AWS::StackId

  InternetGateway:
    Type: "AWS::EC2::InternetGateway"
    Properties:
      Tags:
        - Key: Application
          Value: AWS-Alphafold
        - Key: Network
          Value: Public
        - Key: Name
          Value:
            !Join [
              "-",
              [
                "AWS-Alphafold",
                "igw",
                !Select [
                  4,
                  !Split ["-", !Select [2, !Split ["/", !Ref AWS::StackId]]],
                ],
              ],
            ]
        - Key: StackId
          Value: !Ref AWS::StackId

  GatewayToInternet:
    Type: "AWS::EC2::VPCGatewayAttachment"
    Properties:
      VpcId:
        Ref: VPC
      InternetGatewayId:
        Ref: InternetGateway

  PublicRouteTable:
    Type: "AWS::EC2::RouteTable"
    Properties:
      VpcId:
        Ref: VPC
      Tags:
        - Key: Application
          Value: AWS-Alphafold
        - Key: Network
          Value: Public
        - Key: Name
          Value:
            !Join [
              "-",
              [
                "AWS-Alphafold",
                "public-route-table",
                !Select [
                  4,
                  !Split ["-", !Select [2, !Split ["/", !Ref AWS::StackId]]],
                ],
              ],
            ]
        - Key: StackId
          Value: !Ref AWS::StackId

  PublicRoute:
    Type: "AWS::EC2::Route"
    DependsOn: GatewayToInternet
    Properties:
      RouteTableId:
        Ref: PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId:
        Ref: InternetGateway

  PublicSubnetRouteTableAssociation0:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Properties:
      SubnetId:
        Ref: PublicSubnet0
      RouteTableId:
        Ref: PublicRouteTable

  ElasticIP0:
    Type: "AWS::EC2::EIP"
    Properties:
      Domain: vpc
      Tags:
        - Key: Application
          Value: AWS-Alphafold
        - Key: Name
          Value:
            !Join [
              "-",
              [
                "AWS-Alphafold",
                "eip",
                !Select [
                  4,
                  !Split ["-", !Select [2, !Split ["/", !Ref AWS::StackId]]],
                ],
              ],
            ]
        - Key: StackId
          Value: !Ref AWS::StackId

  NATGateway0:
    Type: "AWS::EC2::NatGateway"
    Properties:
      AllocationId:
        "Fn::GetAtt":
          - ElasticIP0
          - AllocationId
      SubnetId:
        Ref: PublicSubnet0
      Tags:
        - Key: Application
          Value: AWS-Alphafold
        - Key: Name
          Value:
            !Join [
              "-",
              [
                "AWS-Alphafold",
                "nat-gateway",
                !Select [
                  4,
                  !Split ["-", !Select [2, !Split ["/", !Ref AWS::StackId]]],
                ],
              ],
            ]
        - Key: StackId
          Value: !Ref AWS::StackId

  PrivateRouteTable0:
    Type: "AWS::EC2::RouteTable"
    Properties:
      VpcId:
        Ref: VPC
      Tags:
        - Key: Application
          Value: AWS-Alphafold
        - Key: Name
          Value:
            !Join [
              "-",
              [
                "AWS-Alphafold",
                "private-route-table",
                !Select [
                  4,
                  !Split ["-", !Select [2, !Split ["/", !Ref AWS::StackId]]],
                ],
              ],
            ]
        - Key: StackId
          Value: !Ref AWS::StackId

  PrivateRouteToInternet0:
    Type: "AWS::EC2::Route"
    Properties:
      RouteTableId:
        Ref: PrivateRouteTable0
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId:
        Ref: NATGateway0

  PrivateSubnetRouteTableAssociation0:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Properties:
      SubnetId:
        Ref: PrivateSubnet0
      RouteTableId:
        Ref: PrivateRouteTable0

  ##################################################
  # S3
  ##################################################

  CodePipelineS3Bucket:
    Type: "AWS::S3::Bucket"
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      AccessControl: Private
      LoggingConfiguration:
        LogFilePrefix: code-pipeline-logs
      Tags:
        - Key: Application
          Value: AWS-Alphafold
        - Key: Name
          Value:
            !Join [
              "-",
              [
                "AWS-Alphafold",
                "s3",
                !Select [
                  4,
                  !Split ["-", !Select [2, !Split ["/", !Ref AWS::StackId]]],
                ],
              ],
            ]
        - Key: StackId
          Value: !Ref AWS::StackId
    DeletionPolicy: Retain
    UpdateReplacePolicy : Retain

  S3BucketPolicy:
    Type: "AWS::S3::BucketPolicy"
    Properties: 
      Bucket: !Ref CodePipelineS3Bucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
              - s3:GetObject
              - s3:PutObject
              - s3:GetObjectVersion
            Effect: Allow
            Resource: 
              - !Sub arn:aws:s3:::${CodePipelineS3Bucket}/*
            Principal: 
              AWS: !Ref AWS::AccountId
          - Action:
              - s3:GetBucketAcl
              - s3:GetBucketLocation  
              - s3:PutBucketPolicy
            Effect: Allow
            Resource: 
              - !GetAtt CodePipelineS3Bucket.Arn
            Principal: 
              AWS: !Ref AWS::AccountId                
          
  S3Endpoint:
    Type: "AWS::EC2::VPCEndpoint"
    Properties:
      RouteTableIds:
        - !Ref PublicRouteTable
        - !Ref PrivateRouteTable0
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.s3"
      VpcId: !Ref VPC

  ##################################################
  # FSx File System
  ##################################################
  FSX:
    Type: AWS::FSx::FileSystem
    Properties:
      FileSystemType: "LUSTRE"
      FileSystemTypeVersion: "2.12"
      LustreConfiguration:
        DataCompressionType: "LZ4"
        DeploymentType: "PERSISTENT_2"
        PerUnitStorageThroughput: !Ref FSxForLustreThroughput
      SecurityGroupIds:
        - !GetAtt VPC.DefaultSecurityGroup
      StorageCapacity: !Ref FSXForLustreStorageCapacity
      StorageType: "SSD"
      SubnetIds:
        - !Ref PrivateSubnet0      
      Tags:
        - Key: Application
          Value: AWS-Alphafold
        - Key: Name
          Value:
            !Join [
              "-",
              [
                "AWS-Alphafold",
                "fsx-lustre",
                !Select [
                  4,
                  !Split ["-", !Select [2, !Split ["/", !Ref AWS::StackId]]],
                ],
              ],
            ]
        - Key: StackId
          Value: !Ref AWS::StackId

  ##################################################
  # EC2 Launch Template
  ##################################################

  EC2InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      Description: "Required service policies to support running Alphafold on AWS Batch"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - "sts:AssumeRole"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
        - arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceforEC2Role
        - arn:aws:iam::aws:policy/AmazonS3FullAccess
      Tags:
        - Key: Application
          Value: AWS-Alphafold
        - Key: Name
          Value:
            !Join [
              "-",
              [
                "AWS-Alphafold",
                "instance-role",
                !Select [
                  4,
                  !Split ["-", !Select [2, !Split ["/", !Ref AWS::StackId]]],
                ],
              ],
            ]
        - Key: StackId
          Value: !Ref AWS::StackId

  InstanceProfile:
    Type: "AWS::IAM::InstanceProfile"
    Properties:
      InstanceProfileName:
        !Join [
          "-",
          [
            "AWS-Alphafold",
            "instance-profile",
            !Select [
              4,
              !Split ["-", !Select [2, !Split ["/", !Ref AWS::StackId]]],
            ],
          ],
        ]
      Roles:
        - !Ref EC2InstanceRole

  InstanceLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName:
        !Join [
          "-",
          [
            "AWS-Alphafold",
            "launch-template",
            !Select [
              4,
              !Split ["-", !Select [2, !Split ["/", !Ref AWS::StackId]]],
            ],
          ],
        ]
      LaunchTemplateData:
        BlockDeviceMappings:
          - DeviceName: "/dev/xvda"
            Ebs:
              DeleteOnTermination: true
              Encrypted: true
              VolumeSize: 50
              VolumeType: "gp2"
        IamInstanceProfile:
          Name: !Ref InstanceProfile
        TagSpecifications:
          - ResourceType: "instance"
            Tags:
              - Key: Application
                Value: AWS-Alphafold
              - Key: Name
                Value:
                  !Join [
                    "-",
                    [
                      "AWS-Alphafold",
                      "launch-template",
                      !Select [
                        4,
                        !Split [
                          "-",
                          !Select [2, !Split ["/", !Ref AWS::StackId]],
                        ],
                      ],
                    ],
                  ]
              - Key: StackId
                Value: !Ref AWS::StackId
        UserData:
          Fn::Base64:
            Fn::Join:
              [
                "",
                [
                  "MIME-Version: 1.0\n",
                  "Content-Type: multipart/mixed; boundary=\"==MYBOUNDARY==\"\n",
                  "\n",
                  "--==MYBOUNDARY==\n",
                  "Content-Type: text/cloud-config; charset=\"us-ascii\"\n",
                  "\n",
                  "runcmd:\n",
                  "- file_system_id_01=",
                  !Ref FSX,
                  "\n",
                  "- region=",
                  !Ref AWS::Region,
                  "\n",
                  "- fsx_directory=/fsx\n",
                  "- fsx_mount_name=",
                  !GetAtt FSX.LustreMountName,
                  "\n",
                  "- amazon-linux-extras install -y lustre2.10\n",
                  "- mkdir -p ${fsx_directory}\n",
                  "- mount -t lustre ${file_system_id_01}.fsx.${region}.amazonaws.com@tcp:/${fsx_mount_name} ${fsx_directory}\n",
                  "\n",
                  "--==MYBOUNDARY==--",
                ],
              ]

  PublicInstanceLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateData:
        BlockDeviceMappings:
          - DeviceName: "/dev/xvda"
            Ebs:
              DeleteOnTermination: true
              Encrypted: true
              VolumeSize: 50
              VolumeType: "gp2"
        IamInstanceProfile:
          Name: !Ref InstanceProfile
        NetworkInterfaces:
          - AssociatePublicIpAddress: True
            DeviceIndex: 0
            Groups:
              - !GetAtt VPC.DefaultSecurityGroup
            SubnetId: !Ref PublicSubnet0
        TagSpecifications:
          - ResourceType: "instance"
            Tags:
              - Key: Application
                Value: AWS-Alphafold
              - Key: Name
                Value:
                  !Join [
                    "-",
                    [
                      "AWS-Alphafold",
                      "public-launch-template",
                      !Select [
                        4,
                        !Split [
                          "-",
                          !Select [2, !Split ["/", !Ref AWS::StackId]],
                        ],
                      ],
                    ],
                  ]
              - Key: StackId
                Value: !Ref AWS::StackId
        UserData:
          Fn::Base64:
            Fn::Join:
              [
                "",
                [
                  "MIME-Version: 1.0\n",
                  "Content-Type: multipart/mixed; boundary=\"==MYBOUNDARY==\"\n",
                  "\n",
                  "--==MYBOUNDARY==\n",
                  "Content-Type: text/cloud-config; charset=\"us-ascii\"\n",
                  "\n",
                  "runcmd:\n",
                  "- file_system_id_01=",
                  !Ref FSX,
                  "\n",
                  "- region=",
                  !Ref AWS::Region,
                  "\n",
                  "- fsx_directory=/fsx\n",
                  "- fsx_mount_name=",
                  !GetAtt FSX.LustreMountName,
                  "\n",
                  "- amazon-linux-extras install -y lustre2.10\n",
                  "- mkdir -p ${fsx_directory}\n",
                  "- mount -t lustre ${file_system_id_01}.fsx.${region}.amazonaws.com@tcp:/${fsx_mount_name} ${fsx_directory}\n",
                  "\n",
                  "--==MYBOUNDARY==--",
                ],
              ]              

  ##################################################
  # Container Services
  ##################################################
  CodeRepository:
    Type: AWS::CodeCommit::Repository
    Properties:
      Code:
        BranchName: "main"
        S3:
          Bucket: "aws-hcls-ml"
          Key: "blog_post_support_materials/aws-alphafold/main/aws-alphafold.zip"
      RepositoryDescription: Code for running Alphafold on AWS
      RepositoryName:
        !Join [
          "-",
          [
            "AWS-Alphafold",
            "code-repo",
            !Select [
              4,
              !Split ["-", !Select [2, !Split ["/", !Ref AWS::StackId]]],
            ],
          ],
        ]
      Tags:
        - Key: Application
          Value: AWS-Alphafold
        - Key: Name
          Value:
            !Join [
              "-",
              [
                "AWS-Alphafold",
                "code-repo",
                !Select [
                  4,
                  !Split ["-", !Select [2, !Split ["/", !Ref AWS::StackId]]],
                ],
              ],
            ]
        - Key: StackId
          Value: !Ref AWS::StackId

  FoldingContainerRegistry:
    Type: AWS::ECR::Repository
    Properties:
      EncryptionConfiguration:
        EncryptionType: AES256
      ImageScanningConfiguration:
        ScanOnPush: true
      Tags:
        - Key: Application
          Value: AWS-Alphafold
        - Key: Name
          Value:
            !Join [
              "-",
              [
                "AWS-Alphafold",
                "folding-container-repo",
                !Select [
                  4,
                  !Split ["-", !Select [2, !Split ["/", !Ref AWS::StackId]]],
                ],
              ],
            ]
        - Key: StackId
          Value: !Ref AWS::StackId
    DeletionPolicy: Retain
    UpdateReplacePolicy : Retain

  DownloadContainerRegistry:
    Type: AWS::ECR::Repository
    Properties:
      EncryptionConfiguration:
        EncryptionType: AES256
      ImageScanningConfiguration:
        ScanOnPush: true
      Tags:
        - Key: Application
          Value: AWS-Alphafold
        - Key: Name
          Value:
            !Join [
              "-",
              [
                "AWS-Alphafold",
                "download-container-repo",
                !Select [
                  4,
                  !Split ["-", !Select [2, !Split ["/", !Ref AWS::StackId]]],
                ],
              ],
            ]
        - Key: StackId
          Value: !Ref AWS::StackId
    DeletionPolicy: Retain
    UpdateReplacePolicy : Retain    

  CodeBuildRole:
    Type: AWS::IAM::Role
    Properties:
      Description: "Required service policies to support building AWS-Alphafold container"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - codebuild.amazonaws.com
            Action:
              - "sts:AssumeRole"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryFullAccess
      Policies:
        - PolicyName: CodeBuildPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource:
                  - Fn::Join:
                      [
                        ":",
                        [
                          "arn:aws:logs",
                          !Ref AWS::Region,
                          !Ref AWS::AccountId,
                          "log-group:/aws/codebuild/AWS-Alphafold*",
                        ],
                      ]
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:GetObject
                  - s3:GetObjectVersion
                  - s3:GetBucketAcl
                  - s3:GetBucketLocation
                Resource:
                  - !Join [
                      "-",
                      ["arn:aws:s3:::codepipeline", !Ref AWS::Region, "*"],
                    ]
                  - !Join ["", [!GetAtt CodePipelineS3Bucket.Arn, "*"]]
              - Effect: Allow
                Action:
                  - codecommit:GitPull
                Resource:
                  - Fn::Join:
                      [
                        ":",
                        [
                          "arn:aws:codecommit",
                          !Ref AWS::Region,
                          !Ref AWS::AccountId,
                          !GetAtt CodeRepository.Name,
                        ],
                      ]
              - Effect: Allow
                Action:
                  - codebuild:CreateReportGroup
                  - codebuild:CreateReport
                  - codebuild:UpdateReport
                  - codebuild:BatchPutTestCases
                  - codebuild:BatchPutCodeCoverages
                Resource:
                  - Fn::Join:
                      [
                        ":",
                        [
                          "arn:aws:s3:::codebuild",
                          !Ref AWS::Region,
                          !Ref AWS::AccountId,
                          "report-group/AWS-Alphafold*",
                        ],
                      ]
      Tags:
        - Key: Application
          Value: AWS-Alphafold
        - Key: Name
          Value:
            !Join [
              "-",
              [
                "AWS-Alphafold",
                "codebuild-role",
                !Select [
                  4,
                  !Split ["-", !Select [2, !Split ["/", !Ref AWS::StackId]]],
                ],
              ],
            ]
        - Key: StackId
          Value: !Ref AWS::StackId

  EncryptionKey:
    Type: "AWS::KMS::Key"
    Properties:
      EnableKeyRotation: true
      KeyPolicy:
        Version: 2012-10-17
        Id: key-default-1
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: 
                Fn::Join: [":", ["arn:aws:iam:", !Ref AWS::AccountId, "root"]]
            Action: 
              [
                "kms:Create*",
                "kms:Describe*",
                "kms:Enable*",
                "kms:List*",
                "kms:Put*",
                "kms:Update*",
                "kms:Revoke*",
                "kms:Disable*",
                "kms:Get*",
                "kms:Delete*",
                "kms:TagResource",
                "kms:UntagResource",
                "kms:ScheduleKeyDeletion",
                "kms:CancelKeyDeletion",
              ]
            Resource: "*"
          - Sid: Enable CodeBuild Encryption
            Effect: Allow
            Principal:
              AWS: !GetAtt CodeBuildRole.Arn
            Action:
              [
                "kms:Encrypt",
                "kms:Decrypt",
                "kms:ReEncrypt*",
                "kms:GenerateDataKey*",
                "kms:DescribeKey",
              ]
            Resource: "*"
          - Sid: Enable CloudWatch Logs Encryption
            Effect: Allow
            Principal:
              Service: "logs.amazonaws.com"
            Action:
              [
                "kms:Encrypt",
                "kms:Decrypt",
                "kms:ReEncrypt*",
                "kms:GenerateDataKey*",
                "kms:DescribeKey",
              ]
            Resource: "*"            
      Tags:
        - Key: Application
          Value: AWS-Alphafold
        - Key: Name
          Value:
            !Join [
              "-",
              [
                "AWS-Alphafold",
                "kms",
                !Select [
                  4,
                  !Split ["-", !Select [2, !Split ["/", !Ref AWS::StackId]]],
                ],
              ],
            ]
        - Key: StackId
          Value: !Ref AWS::StackId

  CodeBuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Artifacts:
        Type: NO_ARTIFACTS
      Description: Build Docker container for Alphafold execution on AWS Batch
      EncryptionKey: !Ref EncryptionKey
      Environment:
        ComputeType: BUILD_GENERAL1_MEDIUM
        EnvironmentVariables:
          - Name: FOLDING_IMAGE_TAG
            Value: latest
          - Name: FOLDING_IMAGE_REPO_NAME
            Value: !Ref FoldingContainerRegistry
          - Name: AF_VERSION
            Value: !Ref AlphaFoldVersion
          - Name: DOWNLOAD_IMAGE_TAG
            Value: latest
          - Name: DOWNLOAD_IMAGE_REPO_NAME
            Value: !Ref DownloadContainerRegistry            
          - Name: ACCOUNT_ID
            Value: !Ref AWS::AccountId
        Image: aws/codebuild/standard:4.0
        ImagePullCredentialsType: CODEBUILD
        PrivilegedMode: true
        Type: LINUX_CONTAINER
      Name:
        !Join [
          "-",
          [
            "AWS-Alphafold",
            "codebuild-project",
            !Select [
              4,
              !Split ["-", !Select [2, !Split ["/", !Ref AWS::StackId]]],
            ],
          ],
        ]
      ResourceAccessRole: !GetAtt CodeBuildRole.Arn
      ServiceRole: !GetAtt CodeBuildRole.Arn
      Source:
        BuildSpec: infrastructure/buildspec.yaml
        GitCloneDepth: 1
        Location: !GetAtt CodeRepository.CloneUrlHttp
        Type: CODECOMMIT
      SourceVersion: refs/heads/main
      Tags:
        - Key: Application
          Value: AWS-Alphafold
        - Key: Name
          Value:
            !Join [
              "-",
              [
                "AWS-Alphafold",
                "codebuild-project",
                !Select [
                  4,
                  !Split ["-", !Select [2, !Split ["/", !Ref AWS::StackId]]],
                ],
              ],
            ]
        - Key: StackId
          Value: !Ref AWS::StackId

  CodePipelineRole:
    Type: AWS::IAM::Role
    Properties:
      Description: "Required service policies to support running AWS-Alphafold build pipeline"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - codepipeline.amazonaws.com
            Action:
              - "sts:AssumeRole"
      Policies:
        - PolicyName: codePipelinePolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Action:
                  - codecommit:CancelUploadArchive
                  - codecommit:GetBranch
                  - codecommit:GetCommit
                  - codecommit:GetRepository
                  - codecommit:GetUploadArchiveStatus
                  - codecommit:UploadArchive
                Resource: !GetAtt CodeRepository.Arn
                Effect: Allow
              - Action:
                  - s3:PutObject
                  - s3:GetObject
                  - s3:GetObjectVersion
                Resource: !Sub arn:aws:s3:::${CodePipelineS3Bucket}/*
                Effect: Allow
              - Action:
                  - s3:GetBucketAcl
                  - s3:GetBucketLocation
                Resource: !GetAtt CodePipelineS3Bucket.Arn
                Effect: Allow
              - Action:
                  - codebuild:BatchGetBuilds
                  - codebuild:StartBuild
                  - codebuild:BatchGetBuildBatches
                  - codebuild:StartBuildBatch
                Resource: !GetAtt CodeBuildProject.Arn
                Effect: Allow
              - Effect: Allow
                Action:
                  - ecr:DescribeImages
                Resource: !GetAtt FoldingContainerRegistry.Arn
      Tags:
        - Key: Application
          Value: AWS-Alphafold
        - Key: Name
          Value:
            !Join [
              "-",
              [
                "AWS-Alphafold",
                "codepipeline-role",
                !Select [
                  4,
                  !Split ["-", !Select [2, !Split ["/", !Ref AWS::StackId]]],
                ],
              ],
            ]
        - Key: StackId
          Value: !Ref AWS::StackId

  CodePipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      ArtifactStore:
        Location: !Ref CodePipelineS3Bucket
        Type: S3
      Name:
        !Join [
          "-",
          [
            "AWS-Alphafold",
            "codepipeline",
            !Select [
              4,
              !Split ["-", !Select [2, !Split ["/", !Ref AWS::StackId]]],
            ],
          ],
        ]
      RestartExecutionOnUpdate: true
      RoleArn: !GetAtt CodePipelineRole.Arn
      Stages:
        - Name: Source
          Actions:
            - Name: Source
              ActionTypeId:
                Category: Source
                Owner: AWS
                Provider: CodeCommit
                Version: 1
              Configuration:
                RepositoryName: !GetAtt CodeRepository.Name
                BranchName: main
                PollForSourceChanges: "false"
              Namespace: SourceVariables
              OutputArtifacts:
                - Name: SourceArtifact
              Region: !Ref AWS::Region
              RunOrder: 1
        - Name: Build
          Actions:
            - Name: Build
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: 1
              Configuration:
                ProjectName: !Ref CodeBuildProject
              InputArtifacts:
                - Name: SourceArtifact
              Namespace: BuildVariables
              OutputArtifacts:
                - Name: BuildArtifact
              Region: !Ref AWS::Region
              RunOrder: 2
      Tags:
        - Key: Application
          Value: AWS-Alphafold
        - Key: Name
          Value:
            !Join [
              "-",
              [
                "AWS-Alphafold",
                "codepipeline",
                !Select [
                  4,
                  !Split ["-", !Select [2, !Split ["/", !Ref AWS::StackId]]],
                ],
              ],
            ]
        - Key: StackId
          Value: !Ref AWS::StackId

  ##################################################
  # Batch Environment
  ##################################################

  PrivateCPUComputeEnvironment:
    Type: AWS::Batch::ComputeEnvironment
    Properties:
      ComputeResources:
        AllocationStrategy: BEST_FIT_PROGRESSIVE
        InstanceRole: !Ref InstanceProfile
        InstanceTypes:
          - m5
          - r5
          - c5
        LaunchTemplate:
          LaunchTemplateId: !Ref InstanceLaunchTemplate
          Version: $Latest
        MaxvCpus: 256
        MinvCpus: 0
        SecurityGroupIds:
          - !GetAtt VPC.DefaultSecurityGroup
        Subnets:
          - Ref: PrivateSubnet0
        Type: EC2
      State: ENABLED
      Type: MANAGED
      Tags:
        Application: AWS-Alphafold
        StackId: !Ref AWS::StackId

  PublicCPUComputeEnvironment:
    Type: AWS::Batch::ComputeEnvironment
    Properties:
      ComputeResources:
        AllocationStrategy: BEST_FIT_PROGRESSIVE
        InstanceRole: !Ref InstanceProfile
        InstanceTypes:
          - m5
          - r5
          - c5
        LaunchTemplate:
          LaunchTemplateId: !Ref PublicInstanceLaunchTemplate
          Version: $Latest
        MaxvCpus: 256
        MinvCpus: 0
        Subnets:
          - Ref: PublicSubnet0
        Type: EC2
      State: ENABLED
      Type: MANAGED
      Tags:
        Application: AWS-Alphafold
        StackId: !Ref AWS::StackId

  PrivateGPUComputeEnvironment:
    Type: AWS::Batch::ComputeEnvironment
    Properties:
      ComputeResources:
        AllocationStrategy: BEST_FIT_PROGRESSIVE
        InstanceRole: !Ref InstanceProfile
        InstanceTypes:
          - g4dn
        LaunchTemplate:
          LaunchTemplateId: !Ref InstanceLaunchTemplate
          Version: $Latest
        MaxvCpus: 256
        MinvCpus: 0
        SecurityGroupIds:
          - !GetAtt VPC.DefaultSecurityGroup
        Subnets:
          - Ref: PrivateSubnet0
        Type: EC2
      State: ENABLED
      Type: MANAGED
      Tags:
        Application: AWS-Alphafold
        Name:
          !Join [
            "-",
            [
              "AWS-Alphafold",
              "private-ce-gpu",
              !Select [
                4,
                !Split ["-", !Select [2, !Split ["/", !Ref AWS::StackId]]],
              ],
            ],
          ]
        StackId: !Ref AWS::StackId

  PrivateCPUJobQueue:
    Type: AWS::Batch::JobQueue
    Properties:
      ComputeEnvironmentOrder:
        - ComputeEnvironment: !Ref PrivateCPUComputeEnvironment
          Order: 1
      Priority: 10
      State: ENABLED
      Tags:
        Application: AWS-Alphafold
        StackId: !Ref AWS::StackId

  PublicCPUJobQueue:
    Type: AWS::Batch::JobQueue
    Properties:
      ComputeEnvironmentOrder:
        - ComputeEnvironment: !Ref PublicCPUComputeEnvironment
          Order: 1
      Priority: 10
      State: ENABLED
      Tags:
        Application: AWS-Alphafold
        StackId: !Ref AWS::StackId       

  PrivateGPUJobQueue:
    Type: AWS::Batch::JobQueue
    Properties:
      ComputeEnvironmentOrder:
        - ComputeEnvironment: !Ref PrivateGPUComputeEnvironment
          Order: 1
      Priority: 10
      State: ENABLED
      Tags:
        Application: AWS-Alphafold
        StackId: !Ref AWS::StackId

  CPUFoldingJobDefinition:
    Type: AWS::Batch::JobDefinition
    Properties:
      ContainerProperties:
        Command:
          - "-c echo hello, world"    
        Image:
          !Join [":", [!GetAtt FoldingContainerRegistry.RepositoryUri, "latest"]]
        LogConfiguration:
          LogDriver: awslogs
        MountPoints:
          - ContainerPath: /mnt/bfd_database_path
            ReadOnly: True
            SourceVolume: bfd        
          - ContainerPath: /mnt/mgnify_database_path
            ReadOnly: True
            SourceVolume: mgnify            
          - ContainerPath: /mnt/pdb70_database_path
            ReadOnly: True
            SourceVolume: pdb70
          - ContainerPath: /mnt/template_mmcif_dir
            ReadOnly: True
            SourceVolume: pdb_mmcif
          - ContainerPath: /mnt/obsolete_pdbs_path
            ReadOnly: True
            SourceVolume: pdb_mmcif
          - ContainerPath: /mnt/pdb_seqres_database_path
            ReadOnly: True
            SourceVolume: pdb_seqres            
          - ContainerPath: /mnt/small_bfd_database_path
            ReadOnly: True
            SourceVolume: small_bfd
          - ContainerPath: /mnt/uniclust30_database_path
            ReadOnly: True
            SourceVolume: uniclust30
          - ContainerPath: /mnt/uniprot_database_path
            ReadOnly: True
            SourceVolume: uniprot     
          - ContainerPath: /mnt/uniref90_database_path
            ReadOnly: True
            SourceVolume: uniref90                   
          - ContainerPath: /mnt/data_dir
            ReadOnly: True
            SourceVolume: data
          - ContainerPath: /mnt/output
            ReadOnly: False
            SourceVolume: output
        ResourceRequirements:
          - Type: VCPU
            Value: 8
          - Type: MEMORY
            Value: 16000
        Volumes:
          - Name: bfd
            Host:
              SourcePath: /fsx/bfd
          - Name: mgnify
            Host:
              SourcePath: /fsx/mgnify    
          - Name: pdb70
            Host:
              SourcePath: /fsx/pdb70   
          - Name: pdb_mmcif
            Host:
              SourcePath: /fsx/pdb_mmcif  
          - Name: pdb_seqres
            Host:
              SourcePath: /fsx/pdb_seqres  
          - Name: small_bfd
            Host:
              SourcePath: /fsx/small_bfd
          - Name: uniclust30
            Host:
              SourcePath: /fsx/uniclust30
          - Name: uniprot
            Host:
              SourcePath: /fsx/uniprot                                                                                               
          - Name: uniref90
            Host:
              SourcePath: /fsx/uniref90   
          - Name: data
            Host:
              SourcePath: /    
          - Name: output
            Host:
              SourcePath: /tmp/alphafold
      PlatformCapabilities:
        - EC2
      PropagateTags: true
      RetryStrategy:
        Attempts: 3
      Tags:
        Application: AWS-Alphafold
        StackId: !Ref AWS::StackId
      Type: container       

  GPUFoldingJobDefinition:
    Type: AWS::Batch::JobDefinition
    Properties:
      ContainerProperties:
        Command:
          - "nvidia-smi"
        Environment:
          - Name: TF_FORCE_UNIFIED_MEMORY
            Value: 1
          - Name: XLA_PYTHON_CLIENT_MEM_FRACTION
            Value: 4.0
        Image:
          !Join [":", [!GetAtt FoldingContainerRegistry.RepositoryUri, "latest"]]
        LogConfiguration:
          LogDriver: awslogs
        MountPoints:
          - ContainerPath: /mnt/bfd_database_path
            ReadOnly: True
            SourceVolume: bfd        
          - ContainerPath: /mnt/mgnify_database_path
            ReadOnly: True
            SourceVolume: mgnify            
          - ContainerPath: /mnt/pdb70_database_path
            ReadOnly: True
            SourceVolume: pdb70
          - ContainerPath: /mnt/template_mmcif_dir
            ReadOnly: True
            SourceVolume: pdb_mmcif
          - ContainerPath: /mnt/obsolete_pdbs_path
            ReadOnly: True
            SourceVolume: pdb_mmcif
          - ContainerPath: /mnt/pdb_seqres_database_path
            ReadOnly: True
            SourceVolume: pdb_seqres            
          - ContainerPath: /mnt/small_bfd_database_path
            ReadOnly: True
            SourceVolume: small_bfd
          - ContainerPath: /mnt/uniclust30_database_path
            ReadOnly: True
            SourceVolume: uniclust30
          - ContainerPath: /mnt/uniprot_database_path
            ReadOnly: True
            SourceVolume: uniprot     
          - ContainerPath: /mnt/uniref90_database_path
            ReadOnly: True
            SourceVolume: uniref90                   
          - ContainerPath: /mnt/data_dir
            ReadOnly: True
            SourceVolume: data
          - ContainerPath: /mnt/output
            ReadOnly: False
            SourceVolume: output
        ResourceRequirements:
          - Type: VCPU
            Value: 8
          - Type: MEMORY
            Value: 16000
          - Type: GPU
            Value: 1
        Volumes:
          - Name: bfd
            Host:
              SourcePath: /fsx/bfd
          - Name: mgnify
            Host:
              SourcePath: /fsx/mgnify    
          - Name: pdb70
            Host:
              SourcePath: /fsx/pdb70   
          - Name: pdb_mmcif
            Host:
              SourcePath: /fsx/pdb_mmcif  
          - Name: pdb_seqres
            Host:
              SourcePath: /fsx/pdb_seqres  
          - Name: small_bfd
            Host:
              SourcePath: /fsx/small_bfd
          - Name: uniclust30
            Host:
              SourcePath: /fsx/uniclust30
          - Name: uniprot
            Host:
              SourcePath: /fsx/uniprot                                                                                               
          - Name: uniref90
            Host:
              SourcePath: /fsx/uniref90   
          - Name: data
            Host:
              SourcePath: /    
          - Name: output
            Host:
              SourcePath: /tmp/alphafold
      PlatformCapabilities:
        - EC2
      PropagateTags: true
      RetryStrategy:
        Attempts: 3
      Tags:
        Application: AWS-Alphafold
        StackId: !Ref AWS::StackId
      Type: container

  CPUDownloadJobDefinition:
      Type: AWS::Batch::JobDefinition
      Properties:
        ContainerProperties:
          Command:
            - "-c echo hello, world"
          Image:
            !Join [":", [!GetAtt DownloadContainerRegistry.RepositoryUri, "latest"]]
          LogConfiguration:
            LogDriver: awslogs
          MountPoints:
            - ContainerPath: /fsx
              ReadOnly: False
              SourceVolume: fsx
          Privileged: False
          ResourceRequirements:
            - Type: VCPU
              Value: 4
            - Type: MEMORY
              Value: 16000
          Volumes:
            - Name: fsx
              Host:
                SourcePath: /fsx
        PlatformCapabilities:
          - EC2
        PropagateTags: true
        RetryStrategy:
          Attempts: 3
        Tags:
          Application: AWS-Alphafold
          StackId: !Ref AWS::StackId
        Type: container      

  ##################################################
  # SageMaker Notebook Instance
  ##################################################

  AlphafoldNotebookInstance:
    Type: "AWS::SageMaker::NotebookInstance"
    Condition: createSageMakerNotebook
    Properties:
      DirectInternetAccess: Enabled
      InstanceType: ml.c4.2xlarge
      DefaultCodeRepository:  !GetAtt CodeRepository.CloneUrlHttp
      KmsKeyId: !GetAtt EncryptionKey.Arn
      RoleArn: !GetAtt SageMakerNotebookExecutionRole.Arn
      SubnetId: !Ref PrivateSubnet0
      SecurityGroupIds:
        - !GetAtt VPC.DefaultSecurityGroup
      Tags:
        - Key:  "Application"
          Value:  "AWS-Alphafold"
        - Key:  "StackId"
          Value:  !Ref AWS::StackId
  SageMakerNotebookExecutionRole: 
    Type: "AWS::IAM::Role"
    Properties: 
      AssumeRolePolicyDocument: 
        Version: "2012-10-17"
        Statement: 
          - 
            Effect: "Allow"
            Principal: 
              Service: 
                - "sagemaker.amazonaws.com"
            Action: 
              - "sts:AssumeRole"
      Path: "/"
      ManagedPolicyArns:
        - !Sub "arn:${AWS::Partition}:iam::aws:policy/AmazonSageMakerFullAccess"
        - !Sub "arn:${AWS::Partition}:iam::aws:policy/AWSCodeCommitReadOnly"
        - !Sub "arn:${AWS::Partition}:iam::aws:policy/AWSCloudFormationReadOnlyAccess"
        - !Sub "arn:${AWS::Partition}:iam::aws:policy/AWSBatchFullAccess"
